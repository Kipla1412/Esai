<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medical Voice Assistant</title>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            padding: 20px;
        }

        #chat {
            width: 420px;
            height: 420px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
        }

        .msg {
            margin: 10px 0;
            padding: 10px 14px;
            border-radius: 14px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.4;
        }

        .user {
            background: #0078ff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .agent {
            background: #e6e6e6;
            color: #222;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }

        #controls {
            display: flex;
            width: 420px;
            gap: 8px;
        }

        #textInput {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        button {
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background-color: #0078ff;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #005fc9;
        }

        #micBtn {
            background-color: #ff4747;
        }

        #micBtn.active {
            background-color: #32cd32;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(50, 205, 50, 0.6);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(50, 205, 50, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(50, 205, 50, 0);
            }
        }
    </style>
</head>

<body>
    <h2>Medical Voice Assistant</h2>
    <div id="chat"></div>
    <div id="controls">
        <input type="text" id="textInput" placeholder="Type your message..." />
        <button id="sendBtn">Send</button>
        <button id="micBtn">ðŸŽ¤</button>
    </div>
    <audio id="ttsAudio" hidden></audio>

    <script>
        const SAMPLE_RATE = 16000;
        let ws;
        let micAudioCtx, micSource, micProcessor, micStream;
        let micActive = false;

        const chat = document.getElementById("chat");
        const textInput = document.getElementById("textInput");
        const sendBtn = document.getElementById("sendBtn");
        const micBtn = document.getElementById("micBtn");

        function addMessage(sender, text) {
            const div = document.createElement("div");
            div.className = `msg ${sender}`;
            div.textContent = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function floatTo16BitPCM(float32Array) {
            const buffer = new ArrayBuffer(float32Array.length * 2);
            const view = new DataView(buffer);
            for (let i = 0; i < float32Array.length; i++) {
                const s = Math.max(-1, Math.min(1, float32Array[i]));
                view.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return buffer;
        }

        async function initWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            ws = new WebSocket("ws://localhost:8000/chat");
            ws.binaryType = "arraybuffer";

            ws.onopen = () => console.log("âœ… WebSocket connected");

            ws.onmessage = async (event) => {
                if (typeof event.data === "string") {
                    const text = event.data;
                    const sender = text.startsWith("Agent:") ? "agent" : "user";
                    addMessage(sender, text);
                } else {
                    await playPCM16Audio(event.data);
                }
            };

            ws.onclose = () => console.log("Disconnected from server");
        }

        async function playPCM16Audio(arrayBuffer) {
            pauseMicCapture();
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
            const audioData = new DataView(arrayBuffer);
            const float32Array = new Float32Array(audioData.byteLength / 2);
            for (let i = 0; i < float32Array.length; i++) {
                float32Array[i] = audioData.getInt16(i * 2, true) / 32768;
            }
            const buffer = audioCtx.createBuffer(1, float32Array.length, SAMPLE_RATE);
            buffer.copyToChannel(float32Array, 0);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start();
            source.onended = () => {
                audioCtx.close();
                setTimeout(resumeMicCapture, 200);
            }
        }

        async function startMicCapture() {
            if (micActive) return;
            await initWebSocket();

            micStream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: SAMPLE_RATE, channelCount: 1, echoCancellation: true, noiseSuppression: true } });
            micAudioCtx = new AudioContext({ sampleRate: SAMPLE_RATE });
            micSource = micAudioCtx.createMediaStreamSource(micStream);
            micProcessor = micAudioCtx.createScriptProcessor(4096, 1, 1);

            micProcessor.onaudioprocess = (e) => {
                if (!micActive) return;
                const inputData = e.inputBuffer.getChannelData(0);
                if (ws.readyState === WebSocket.OPEN) ws.send(floatTo16BitPCM(inputData));
            };

            micSource.connect(micProcessor);
            const dummyGain = micAudioCtx.createGain();
            dummyGain.gain.value = 0;
            micProcessor.connect(dummyGain);
            dummyGain.connect(micAudioCtx.destination);

            micActive = true;
        }

        function pauseMicCapture() { micActive = false; }
        function resumeMicCapture() { micActive = true; }

        sendBtn.onclick = async () => {
            const text = textInput.value.trim();
            if (!text) return;
            await initWebSocket();
            if (ws.readyState === WebSocket.OPEN) ws.send(text);
            textInput.value = "";
        };

        micBtn.onclick = async () => {
            if (!micActive) {
                micBtn.classList.add("active");
                micBtn.textContent = "ðŸŸ¢";
                await startMicCapture();
            } else {
                micBtn.classList.remove("active");
                micBtn.textContent = "ðŸŽ¤";
                micProcessor?.disconnect();
                micSource?.disconnect();
                micStream?.getTracks().forEach(track => track.stop());
                micAudioCtx?.close();
                micActive = false;
            }
        };

        textInput.addEventListener("keydown", e => { if (e.key === "Enter") sendBtn.click(); });
    </script>
</body>

</html>